name: Salesforce Validation (Check Only)

on:
  pull_request:
    branches:
      - Dev
      - QA
  pull_request:
    branches:
      - Dev
      - QA
  workflow_dispatch:
    inputs:
      run_tests:
        description: "Run Apex tests?"
        required: true
        type: boolean
        default: true

jobs:
  validate:
    runs-on: ubuntu-latest
    container:
      image: salesforce/cli:latest-full

    env:
      TEST_FLAG: ${{ inputs.run_tests || 'true' }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Print Branch
        run: echo "Branch is ${GITHUB_REF}"

      # ðŸ” Authenticate for Dev Org
      - name: Authenticate to Dev Org
        if: github.base_ref == 'Dev' || github.ref == 'refs/heads/Dev'
        run: |
          echo "${{ secrets.DEV_SFDX_URL }}" > devAuth.txt
          sf org login sfdx-url -f devAuth.txt -a DevOrg -s

      # ðŸ” Authenticate for QA Org
      - name: Authenticate to QA Org
        if: github.base_ref == 'QA' || github.ref == 'refs/heads/QA'
        run: |
          echo "${{ secrets.QA_SFDX_URL }}" > qaAuth.txt
          sf org login sfdx-url -f qaAuth.txt -a QaOrg -s

      # ðŸ§ª Validation Only (check-only deploy)
      - name: Validate Deployment (No Merge)
        run: |
          echo "Running Salesforce validation (checkonly)..."
          if [ "${TEST_FLAG}" = "true" ]; then
            echo "Running validation with local tests..."
            sf project deploy validate -l RunLocalTests -w 60
          else
            echo "Running validation without tests..."
            sf project deploy validate -l NoTestRun -w 60
          fi
